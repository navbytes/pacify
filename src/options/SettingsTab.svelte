<script lang="ts">
  import { settingsStore } from '@/stores/settingsStore'
  import { toastStore } from '@/stores/toastStore'
  import ToggleSwitch from '@/components/ToggleSwitch.svelte'
  import BackupRestore from '@/components/BackupRestore.svelte'
  import FlexGroup from '@/components/FlexGroup.svelte'
  import { I18nService } from '@/services/i18n/i18nService'
  import Text from '@/components/Text.svelte'
  import Tooltip from '@/components/Tooltip.svelte'
  import Card from '@/components/Card.svelte'
  import { Shield, Database, CircleQuestionMark } from 'lucide-svelte'

  let settings = $derived($settingsStore)

  async function handleDisableProxyOnStartupToggle(checked: boolean) {
    await settingsStore.updateSettings({ disableProxyOnStartup: checked })
    toastStore.show(
      checked
        ? I18nService.getMessage('proxyDisabledOnStartup')
        : I18nService.getMessage('proxyPersistOnStartup'),
      'success'
    )
  }
</script>

<div class="py-6 space-y-8">
  <!-- Proxy Behavior Section (Primary) -->
  <div>
    <div class="mb-6 pb-2 border-b border-slate-200 dark:border-slate-700 flex items-center gap-2">
      <Shield size={20} class="text-blue-600 dark:text-blue-400" />
      <h2 class="text-lg font-semibold text-slate-900 dark:text-slate-100 tracking-tight">
        {I18nService.getMessage('settingsProxyBehavior')}
      </h2>
    </div>

    <Card
      classes="ring-2 ring-blue-500/10 dark:ring-blue-400/10 hover:ring-blue-500/20 dark:hover:ring-blue-400/20 hover:shadow-lg transition-all duration-200"
    >
      <FlexGroup
        direction="horizontal"
        childrenGap="lg"
        alignItems="center"
        justifyContent="between"
      >
        <FlexGroup alignItems="start" childrenGap="sm" classes="flex-1">
          <div
            class="flex-shrink-0 w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 dark:from-blue-600 dark:to-blue-700 rounded-lg flex items-center justify-center mt-1 shadow-md hover:shadow-lg hover:scale-110 transition-all duration-200"
          >
            <svelte:component this={Shield} size={20} class="text-white" />
          </div>
          <div class="flex-1">
            <div class="flex items-center gap-2">
              <label
                class="text-base font-semibold cursor-pointer"
                for="disableProxyOnStartupToggle"
              >
                {I18nService.getMessage('disableProxyOnStartup')}
              </label>
              <Tooltip text={I18nService.getMessage('tooltipDisableOnStartup')} position="top">
                <CircleQuestionMark size={16} class="text-slate-400 dark:text-slate-500" />
              </Tooltip>
            </div>
            <Text as="p" size="sm" color="muted" classes="mt-1">
              {I18nService.getMessage('disableProxyOnStartupDescription')}
            </Text>
          </div>
        </FlexGroup>
        <ToggleSwitch
          id="disableProxyOnStartupToggle"
          checked={settings.disableProxyOnStartup}
          onchange={handleDisableProxyOnStartupToggle}
          aria-label="Toggle disable proxy on startup"
        />
      </FlexGroup>
    </Card>
  </div>

  <!-- Data Management Section -->
  <div>
    <div class="mb-6 pb-2 border-b border-slate-200 dark:border-slate-700 flex items-center gap-2">
      <Database size={20} class="text-slate-600 dark:text-slate-400" />
      <h2 class="text-lg font-semibold text-slate-900 dark:text-slate-100 tracking-tight">
        {I18nService.getMessage('settingsDataManagement')}
      </h2>
    </div>

    <BackupRestore onRestore={() => settingsStore.reloadSettings()} />
  </div>
</div>
